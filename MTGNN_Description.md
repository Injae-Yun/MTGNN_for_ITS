# MTGNN 모델 설명서

## 1. 프로젝트 개요

본 프로젝트는 **MTGNN(Multi-component-based Graph Neural Network)** 모델을 교통 예측에 활용합니다. 주요 목표는 교통 센서로부터 수집된 시계열 데이터에 내재된 복잡한 공간적, 시간적 패턴을 학습하여 미래의 교통 상황(예: 속도)을 예측하는 것입니다.

모델은 YAML 설정 파일을 통해 "Korea", "Livinglab" 등 다양한 데이터셋에 맞게 유연하게 구성하고 실행할 수 있도록 설계되었습니다.

---

## 2. 코어 모델 특징 및 설계

코어 모델의 아키텍처는 `Core/net.py`에 정의되어 있으며, 교통의 동적 특성을 모델링하기 위해 여러 핵심 컴포넌트로 구성됩니다.

### 2.1. 그래프 생성자 (`graph_constructor` 클래스)

- **목적**: 교통 네트워크의 각 노드(센서) 간의 관계를 나타내는 동적이고 적응적인 인접 행렬(Adjacency Matrix)을 학습합니다.
- **메커니즘**: 정적으로 미리 정의된 그래프에 의존하는 대신, 데이터로부터 직접 그래프 구조를 학습합니다. 이를 위해 무작위로 노드 임베딩을 초기화하고 이들 간의 유사도를 계산하는 방법을 학습합니다. 이를 통해 물리적인 도로망 그래프에는 나타나지 않는 잠재적인 상호 의존성을 포착할 수 있습니다.

### 2.2. MTGNN 코어 (`mtgnn` 클래스)

네트워크의 중앙 처리 부분으로, 학습된 그래프 구조와 함께 시계열 데이터를 처리합니다.

- **그래프 컨볼루션 모듈**: `mixprop`이라는 혼합 전파 레이어를 사용하여 그래프 전체에 정보를 효율적으로 확산시킵니다. 이를 통해 이웃 노드로부터 정보를 취합하여 공간적 종속성을 포착합니다.

- **시간적 컨볼루션 모듈**: 일련의 `dilated_inception` 레이어를 사용합니다. 이 설계는 모델이 다양한 스케일과 해상도에서 시간적 패턴을 포착할 수 있게 합니다. Dilated Convolution은 넓은 수용장(receptive field)을 제공하여 모델이 정확한 예측을 위해 과거의 먼 시점까지 참고할 수 있게 하며, Inception과 유사한 레이어는 다양한 길이의 특징을 추출하는 데 도움을 줍니다.

- **스킵 및 잔차 연결 (Skip & Residual Connections)**: 아키텍처 전반에 걸쳐 스킵 연결을 사용하여 다른 레이어의 특징을 결합하고, 잔차 연결을 통해 깊은 네트워크의 학습을 안정적으로 만듭니다.

### 2.3. 출력 레이어

네트워크의 마지막단은 완전 연결 레이어(Fully Connected Layers)로 구성되며, 학습된 고차원 표현을 원하는 예측 결과(예: 다음 12개 타임스텝의 교통 속도)로 변환합니다.

---

## 3. 모델 학습 절차

모델의 학습, 평가, 테스트 과정은 `Core/Train_MTGNN.py`의 `trainer` 클래스가 관리하고, 메인 스크립트(예: `Main_MTGNN_Korea.py`)가 전체 흐름을 제어합니다.

전체 절차는 다음과 같습니다:

1.  **설정 로드**: `Config/` 디렉토리에서 YAML 설정 파일을 로드하는 것으로 프로세스가 시작됩니다. 이 파일에는 모든 하이퍼파라미터, 데이터 경로, 모델 세팅, 학습 파라미터 등이 명시되어 있습니다.

2.  **데이터 로딩 및 전처리**: 설정 파일에 명시된 `Dataloader`가 데이터셋을 로드합니다. 이후 데이터는 정규화(Normalization)되고 학습, 검증, 테스트 세트로 분할됩니다.

3.  **모델 및 트레이너 초기화**: 설정 파일의 파라미터를 사용하여 `mtgnn` 모델을 초기화합니다. 그 다음, 모델, 옵티마이저, 손실 함수(예: MAE), 학습률 스케줄러 등을 캡슐화하는 `trainer` 객체를 생성합니다.

4.  **학습 루프 (`train` 메소드)**:
    - 트레이너는 지정된 에포크 수만큼 학습 데이터를 반복합니다.
    - 각 에포크에서 데이터 배치를 모델에 입력하고, 모델의 예측과 실제 값 사이의 손실을 계산한 후, 역전파를 통해 모델의 가중치를 업데이트합니다.
    - 각 에포크가 끝나면 검증 세트로 모델을 평가합니다. 검증 손실을 기준으로 가장 성능이 좋은 모델이 저장됩니다.
    - 과적합을 방지하기 위해 조기 종료(Early Stopping) 기법이 사용됩니다.

5.  **테스트 (`test` 메소드)**:
    - 학습이 완료되면, 저장된 최적의 모델을 로드하여 테스트 세트로 최종 평가를 진행합니다.
    - 최종 성능 지표(예: MAE, MAPE, RMSE)가 계산되고 기록됩니다.

6.  **결과 저장**: 테스트 세트에 대한 모델의 예측 결과는 추가 분석을 위해 `Results/` 디렉토리에 파일로 저장됩니다.